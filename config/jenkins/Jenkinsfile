pipeline {
    agent any

    stages {
        stage('Init volume') {
            steps {
                sh '''
                    if [ -e $(docker volume list -q -f "name=empire-source-volume") ]
                    then
                    	docker volume create --name=empire-source-volume
                    	docker run \
                            --rm \
                            -v empire-source-volume:/git \
                            alpine/git clone https://github.com/vgalloy/empire-server.git
                    fi
                    docker run \
                        --rm \
                        -v empire-source-volume:/home/ \
                        -w /home/empire-server \
                        ubuntu rm -rf target
                '''
            }
        }

        stage('Git fetch') {
            steps {
                sh '''
                    docker run \
                        --rm \
                        -v empire-source-volume:/home/ \
                        -w /home/empire-server \
                        alpine/git fetch
                    docker run \
                        --rm \
                        -v empire-source-volume:/home/ \
                        -w /home/empire-server \
                        alpine/git checkout --force origin/master
                '''
            }
        }

         stage('Maven clean install') {
             steps {
                 sh '''
                     docker container run \
                         --rm \
                         --name=empire-server-maven-builder-java8 \
                         -v empire-source-volume:/src/maven \
                         -w /src/maven/empire-server \
                         maven:3.5.2 mvn clean install
                 '''
             }
         }

        stage('Gradle init builder') {
            steps {
                sh '''
                    if [ -e $(docker container list -aqf "name=empire-server-gradle-builder-java8") ]
                    then
                        docker container create \
                            --name=empire-server-gradle-builder-java8 \
                            -v empire-source-volume:/home/gradle \
                            -w /home/gradle/empire-server \
                            java:openjdk-8 ./gradlew build --project-cache-dir=/home/gradle-cache
                    fi
                '''
            }
        }

        stage('Gradle build') {
            steps {
                sh 'docker container start -a empire-server-gradle-builder-java8'
            }
        }

        stage('Docker build image') {
            steps {
                sh '''
                    docker container run \
                        --rm \
                        -v empire-source-volume:/home/ \
                        -w /home/empire-server \
                        ubuntu mkdir target
                    docker container run \
                        --rm \
                        -v empire-source-volume:/home/ \
                        -w /home/empire-server \
                        ubuntu cp empire-webservice/build/libs/empire-server.jar target/empire-server.jar
                    docker container run \
                        --rm \
                        -v empire-source-volume:/home/ \
                        -w /home/empire-server \
                        -v /var/run/docker.sock:/var/run/docker.sock \
                        docker build -f config/docker/Dockerfile -t registry.vgalloy.com/empire-server:1.$BUILD_NUMBER .
                    docker tag registry.vgalloy.com/empire-server:1.$BUILD_NUMBER registry.vgalloy.com/empire-server:latest
                '''
            }
        }

        stage('Docker push image to registry') {
            steps {

                withCredentials([usernamePassword(credentialsId: 'docker_credential', usernameVariable: 'DOCKER_LOGIN', passwordVariable: 'DOCKER_PASSWORD')]) {
                    sh '''
                        docker login registry.vgalloy.com -p $DOCKER_PASSWORD -u $DOCKER_LOGIN
                        docker push registry.vgalloy.com/empire-server:1.$BUILD_NUMBER
                        docker push registry.vgalloy.com/empire-server:latest
                        docker logout registry.vgalloy.com
                    '''
                }
            }
        }

        stage('Deploy') {
            steps {
                sh "ssh ubuntu@api.empire.vgalloy.com container/empire/deploy.sh"
            }
        }
    }
}
